(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["app~21833f8f"],{"0c12":function(t,e,s){"use strict";s.d(e,"a",(function(){return i}));var a=s("2b0e");const i=new a["default"]},2725:function(t,e,s){"use strict";var a=function(){var t,e,s=this,a=s._self._c;return a("div",{staticClass:"payment-page"},[a("main",{staticClass:"payment-container",style:s.showKeypad&&!s.showChat?{paddingBottom:"300px"}:{}},[s.showKeypad?s._e():a("div",{staticClass:"card"},[s._m(0),s._m(1)]),"other"!==s.clientType||s.showWechatGuide||s.disableAllInput?s._e():a("div",{staticClass:"payment-method-options payment-method-inline"},[a("div",{staticClass:"payment-method-option",class:{active:1===s.selectedPaymentMethod},on:{click:function(t){return s.selectPaymentMethod(1)}}},[s._m(2),a("div",{staticClass:"payment-method-name"},[s._v("微信支付")])]),a("div",{staticClass:"payment-method-option",class:{active:2===s.selectedPaymentMethod},on:{click:function(t){return s.selectPaymentMethod(2)}}},[s._m(3),a("div",{staticClass:"payment-method-name"},[s._v("支付宝支付")])])]),a("div",{staticClass:"payment-amount-section"},[a("label",{staticClass:"payment-amount-label"},[s._v("支付金额")]),a("div",{staticClass:"amount-input-container",on:{click:function(t){return t.stopPropagation(),s.toggleKeypad.apply(null,arguments)}}},[a("span",{staticClass:"currency-symbol"},[s._v("¥")]),a("input",{staticClass:"amount-input",attrs:{type:"text",readonly:"",disabled:s.disableAllInput||s.showWechatGuide},domProps:{value:s.formattedAmount},on:{click:function(t){return t.stopPropagation(),s.toggleKeypad.apply(null,arguments)}}})])]),s.showKeypad?s._e():a("button",{staticClass:"pay-button",class:{active:s.isValidAmount&&!s.error,loading:s.processing},attrs:{disabled:!s.isValidAmount||s.error||s.processing||s.showWechatGuide||"other"===s.clientType&&null===s.selectedPaymentMethod||s.isPreRunning},on:{click:s.processPayment}},[s.processing||s.isPreRunning?s.isPreRunning?[s._m(4)]:[s._m(5)]:[a("span",{staticClass:"pay-text"},[s._v("立即支付")])]],2),a("div",{directives:[{name:"show",rawName:"v-show",value:s.showKeypad&&!s.showChat,expression:"showKeypad && !showChat"}],staticClass:"keypad",on:{click:function(t){t.stopPropagation()}}},[a("div",{staticClass:"keypad-container"},[a("div",{staticClass:"keypad-numbers"},[a("button",{staticClass:"keypad-button",attrs:{type:"button",disabled:s.disableAllInput||s.showWechatGuide},on:{click:function(t){return t.stopPropagation(),s.inputNumber(1)}}},[s._v("1")]),a("button",{staticClass:"keypad-button",attrs:{type:"button",disabled:s.disableAllInput||s.showWechatGuide},on:{click:function(t){return t.stopPropagation(),s.inputNumber(2)}}},[s._v("2")]),a("button",{staticClass:"keypad-button",attrs:{type:"button",disabled:s.disableAllInput||s.showWechatGuide},on:{click:function(t){return t.stopPropagation(),s.inputNumber(3)}}},[s._v("3")]),a("button",{staticClass:"keypad-button",attrs:{type:"button",disabled:s.disableAllInput||s.showWechatGuide},on:{click:function(t){return t.stopPropagation(),s.inputNumber(4)}}},[s._v("4")]),a("button",{staticClass:"keypad-button",attrs:{type:"button",disabled:s.disableAllInput||s.showWechatGuide},on:{click:function(t){return t.stopPropagation(),s.inputNumber(5)}}},[s._v("5")]),a("button",{staticClass:"keypad-button",attrs:{type:"button",disabled:s.disableAllInput||s.showWechatGuide},on:{click:function(t){return t.stopPropagation(),s.inputNumber(6)}}},[s._v("6")]),a("button",{staticClass:"keypad-button",attrs:{type:"button",disabled:s.disableAllInput||s.showWechatGuide},on:{click:function(t){return t.stopPropagation(),s.inputNumber(7)}}},[s._v("7")]),a("button",{staticClass:"keypad-button",attrs:{type:"button",disabled:s.disableAllInput||s.showWechatGuide},on:{click:function(t){return t.stopPropagation(),s.inputNumber(8)}}},[s._v("8")]),a("button",{staticClass:"keypad-button",attrs:{type:"button",disabled:s.disableAllInput||s.showWechatGuide},on:{click:function(t){return t.stopPropagation(),s.inputNumber(9)}}},[s._v("9")]),a("button",{staticClass:"keypad-button zero-button",attrs:{type:"button",disabled:s.disableAllInput||s.showWechatGuide},on:{click:function(t){return t.stopPropagation(),s.inputNumber(0)}}},[s._v("0")]),a("button",{staticClass:"keypad-button",attrs:{type:"button",disabled:s.disableAllInput||s.showWechatGuide},on:{click:function(t){return t.stopPropagation(),s.inputDot.apply(null,arguments)}}},[s._v(".")])]),a("div",{staticClass:"keypad-actions"},[a("button",{staticClass:"keypad-button delete-button",attrs:{type:"button",disabled:s.disableAllInput||s.showWechatGuide},on:{click:function(t){return t.stopPropagation(),s.deleteNumber.apply(null,arguments)}}},[a("svg",{attrs:{xmlns:"http://www.w3.org/2000/svg",width:"29",height:"18.82",viewBox:"0 0 29 18.82"}},[a("path",{staticClass:"delete-icon-path",attrs:{d:"M9.41,18.82a1.807,1.807,0,0,1-1.246-.5L.807,11.2A2.274,2.274,0,0,1,0,9.415a2.209,2.209,0,0,1,.8-1.78L8.164.5A1.807,1.807,0,0,1,9.41,0H25.39A3.522,3.522,0,0,1,29,3.411v12a3.517,3.517,0,0,1-3.607,3.411ZM2.03,8.794a.776.776,0,0,0-.283.624.806.806,0,0,0,.283.624L9.4,17.171H25.39a1.8,1.8,0,0,0,1.846-1.746V3.411A1.8,1.8,0,0,0,25.39,1.665H9.4Zm18.3,4-3.343-2.344-3.342,2.342a1.226,1.226,0,0,1-1.355,0,.533.533,0,0,1,0-.951L15.634,9.5,12.292,7.155A.6.6,0,0,1,12,6.68a.6.6,0,0,1,.292-.475,1.226,1.226,0,0,1,1.355,0l3.358,2.344L20.351,6.2a1.226,1.226,0,0,1,1.355,0,.541.541,0,0,1,0,.964L18.361,9.512l3.326,2.333a.533.533,0,0,1,0,.95,1.226,1.226,0,0,1-1.355,0Z"}})])]),a("button",{staticClass:"confirm-pay-button",attrs:{type:"button",disabled:!s.isValidAmount||s.error||s.processing||s.showWechatGuide||"other"===s.clientType&&null===s.selectedPaymentMethod||s.isPreRunning},on:{click:function(t){return t.stopPropagation(),s.processPayment.apply(null,arguments)}}},[s.isPreRunning?[s._v("通道初始化...")]:[s._v("确认支付")]],2)])])]),s.error?a("div",{staticClass:"error-message"},[s._v(" "+s._s(s.error)+" ")]):s._e(),s.loading?a("div",{staticClass:"loading-overlay"},[s._m(6)]):s._e(),s.processing?a("div",{staticClass:"progress-overlay"},[a("div",{staticClass:"progress-container"},[a("div",{staticClass:"progress-bar"},[a("div",{staticClass:"progress-fill",style:{width:s.progressWidth+"%"}})]),a("div",{staticClass:"progress-text"},[s._v(" "+s._s(s.progressText)+" ")])])]):s._e(),s.showAnnouncement&&null!==(t=s.channelSettings)&&void 0!==t&&null!==(e=t.announcement)&&void 0!==e&&e.enabled?a("div",{staticClass:"announcement-overlay"},[a("div",{staticClass:"announcement-modal",on:{click:function(t){t.stopPropagation()}}},[a("div",{staticClass:"announcement-header"},[s._m(7),a("h3",[s._v("重要公告")]),a("button",{staticClass:"close-btn",on:{click:s.closeAnnouncement}},[a("i",{staticClass:"fas fa-times"})])]),a("div",{staticClass:"announcement-content"},[s._v(" "+s._s(s.channelSettings.announcement.content)+" ")]),a("div",{staticClass:"announcement-footer"},[a("button",{staticClass:"confirm-btn",on:{click:s.closeAnnouncement}},[a("i",{staticClass:"fas fa-check"}),a("span",[s._v("我已知晓")])])])])]):s._e(),s.shouldShowChat?a("PaymentChat",{key:s.initialOrder.orderId,attrs:{orderId:s.initialOrder.orderId}}):s._e(),s.showNameInput?a("div",{staticClass:"modal-overlay"},[a("div",{staticClass:"name-input-modal"},[a("h3",[s._v("请输入姓名")]),a("div",{staticClass:"input-group"},[a("input",{directives:[{name:"model",rawName:"v-model",value:s.customerName,expression:"customerName"}],attrs:{type:"text",placeholder:"请输入您的真实姓名",maxlength:"20"},domProps:{value:s.customerName},on:{keyup:function(t){return!t.type.indexOf("key")&&s._k(t.keyCode,"enter",13,t.key,"Enter")?null:s.confirmName.apply(null,arguments)},input:function(t){t.target.composing||(s.customerName=t.target.value)}}}),s.nameError?a("p",{staticClass:"error-text"},[s._v(s._s(s.nameError))]):s._e()]),a("div",{staticClass:"modal-buttons"},[a("button",{staticClass:"cancel-btn",on:{click:s.cancelNameInput}},[s._v("取消")]),a("button",{staticClass:"confirm-btn",attrs:{disabled:!s.isValidName},on:{click:s.confirmName}},[s._v("确认")])])])]):s._e(),s.showPaymentQRModal?a("div",{staticClass:"modal-overlay",on:{click:function(t){t.stopPropagation()}}},[a("div",{staticClass:"payment-link-modal"},[s._m(8),a("div",{staticClass:"modal-content"},[a("p",{staticClass:"modal-info"},[s._v("请使用微信扫描以下二维码完成支付：")]),a("div",{staticClass:"qr-code-container"},[s.qrCodeUrl?a("div",{staticClass:"qr-wrapper"},[a("canvas",{ref:"qrCanvas",staticClass:"qr-canvas",staticStyle:{display:"none"}}),s.qrImageSrc?a("img",{staticClass:"qr-image",attrs:{src:s.qrImageSrc,alt:"微信支付二维码"}}):a("div",{staticClass:"qr-loading"},[s._v("生成二维码中...")])]):s._e()]),a("p",{staticClass:"modal-secondary-info"},[s._v("如果无法扫码支付，请复制以下链接到微信打开：")]),a("div",{staticClass:"payment-link-container"},[a("p",{staticClass:"payment-link"},[s._v(s._s(s.qrCodeText))]),a("button",{staticClass:"copy-btn",on:{click:s.copyPaymentLink}},[a("i",{staticClass:"fas fa-copy"}),s._v(" 复制链接 ")])])])])]):s._e()],1),s.showWechatGuide?a("div",{staticClass:"wechat-guide-overlay-svg"},[a("div",{staticClass:"wechat-guide-content-svg"},[a("svg",{staticClass:"guide-arrow-svg-curved",attrs:{width:"120",height:"120",viewBox:"0 0 120 120",fill:"none",xmlns:"http://www.w3.org/2000/svg"}},[a("path",{attrs:{d:"M90 20 L100 30",stroke:"white","stroke-width":"6","stroke-linecap":"round"}}),a("path",{attrs:{d:"M90 20 L80 30",stroke:"white","stroke-width":"6","stroke-linecap":"round"}}),a("path",{attrs:{d:"M90 30 Q 60 100, 3 100",stroke:"white","stroke-width":"6","stroke-linecap":"round","stroke-dasharray":"10 8",fill:"none"}})]),s._m(9)])]):s._e()])},i=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"card-header"},[e("div",[e("div",{staticClass:"merchant-small-title"},[t._v("收款商户")]),e("div",{staticClass:"merchant-name"},[t._v("WAP")])]),e("img",{staticClass:"merchant-avatar",attrs:{src:s("8f1f"),alt:"收银"}})])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"card-body"},[e("div",{staticClass:"merchant-type"},[t._v("电商专版")]),e("div",{staticClass:"card-body-down"},[e("img",{staticClass:"card-icon",attrs:{src:s("040c"),alt:"card"}}),e("div",{staticClass:"merchant-id-text"},[t._v("商户编号：S1011")])])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"payment-method-icon wechat"},[e("i",{staticClass:"fab fa-weixin"})])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"payment-method-icon alipay"},[e("i",{staticClass:"fab fa-alipay"})])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"spinner-wrapper"},[e("div",{staticClass:"button-spinner"}),e("span",[t._v("通道初始化...")])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"spinner-wrapper"},[e("div",{staticClass:"button-spinner"}),e("span",[t._v("处理中...")])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"loading-container"},[e("div",{staticClass:"loading-spinner"}),e("span",{staticClass:"loading-text"},[t._v("正在加载支付信息...")])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"header-icon"},[e("i",{staticClass:"fas fa-bullhorn"})])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"modal-header"},[e("h3",[t._v("微信支付")])])},function(){var t=this,e=t._self._c;return e("p",{staticClass:"guide-text-svg"},[t._v("请点击右上角 "),e("span",{staticClass:"dots-svg"},[t._v("...")]),e("br"),t._v("选择"),e("span",{staticClass:"highlight-svg"},[t._v("「在浏览器中打开」")])])}],r=(s("d9e2"),s("14d9"),s("0c12")),n=function(){var t=this,e=t._self._c;return e("div",{staticClass:"payment-chat"},[e("div",{staticClass:"chat-icon",on:{click:t.toggleChat}},[e("i",{staticClass:"fas fa-comments"}),t.unreadCount>0?e("span",{staticClass:"unread-badge"},[t._v(" "+t._s(t.unreadCount)+" ")]):t._e()]),t.showChat?e("div",{class:["chat-window",{closing:t.isClosing}]},[e("div",{staticClass:"chat-header"},[t._m(0),e("button",{staticClass:"close-btn",attrs:{title:"关闭"},on:{click:t.closeChat}},[e("i",{staticClass:"fas fa-times"})])]),e("div",{ref:"messageContainer",staticClass:"chat-messages"},t._l(t.messages,(function(s){return e("div",{key:s._id,class:["message",t.getMessageClass(s)]},[t.showSenderInfo(s)?e("div",{staticClass:"sender-info"},[t._v(" "+t._s(t.getSenderLabel(s))+" ")]):t._e(),e("div",{staticClass:"message-content"},["image"===s.type?[e("img",{staticClass:"chat-image",attrs:{src:t.getImageUrl(s.content),alt:"聊天图片"},on:{click:function(e){t.previewImage=t.getImageUrl(s.content)},error:t.handleImageError}})]:[t._v(" "+t._s(s.content)+" ")]],2),e("div",{staticClass:"message-time"},[t._v(t._s(t.formatTime(s.createdAt)))])])})),0),e("div",{staticClass:"chat-input"},[t.showEmojiPicker?e("div",{staticClass:"emoji-picker"},[e("div",{staticClass:"emoji-container"},t._l(t.emojis,(function(s){return e("span",{key:s,staticClass:"emoji-item",on:{click:function(e){return t.insertEmoji(s)}}},[t._v(t._s(s))])})),0)]):t._e(),e("div",{staticClass:"input-toolbar"},[e("button",{staticClass:"tool-btn",on:{click:t.toggleEmojiPicker}},[e("i",{staticClass:"far fa-smile"})]),e("label",{staticClass:"tool-btn"},[e("i",{staticClass:"far fa-image"}),e("input",{staticStyle:{display:"none"},attrs:{type:"file",accept:"image/*"},on:{change:t.handleImageUpload}})])]),e("input",{directives:[{name:"model",rawName:"v-model",value:t.newMessage,expression:"newMessage"}],ref:"messageInput",attrs:{placeholder:"输入消息..."},domProps:{value:t.newMessage},on:{keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.sendMessage.apply(null,arguments)},input:function(e){e.target.composing||(t.newMessage=e.target.value)}}}),e("button",{attrs:{disabled:!t.canSendMessage},on:{click:function(e){return e.stopPropagation(),t.sendMessage()}}},[e("i",{staticClass:"fas fa-paper-plane"})])])]):t._e(),t.previewImage?e("div",{staticClass:"image-preview-modal",on:{click:t.closePreview}},[e("div",{staticClass:"preview-content",on:{click:function(t){t.stopPropagation()}}},[e("img",{attrs:{src:t.previewImage,alt:"预览图片"}}),e("div",{staticClass:"preview-actions"},[e("button",{staticClass:"cancel-btn",on:{click:t.closePreview}},[t._v("取消")]),t.imageFile?e("button",{staticClass:"send-btn",on:{click:t.sendImage}},[t._v("发送")]):t._e()])])]):t._e()])},o=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"header-content"},[e("i",{staticClass:"fas fa-headset header-icon"}),e("span",{staticClass:"header-title"},[t._v("联系商家")])])}],d=(s("1e70"),s("79a4"),s("c1a1"),s("8b00"),s("a4e7"),s("1e5a"),s("72c3"),s("0643"),s("4e3e"),{name:"PaymentChat",props:{orderId:{type:String,required:!0}},data(){return{showChat:!1,messages:[],newMessage:"",unreadCount:0,socketInitialized:!1,isLoading:!1,localMessages:[],processedMessageIds:new Set,showEmojiPicker:!1,emojis:["😊","😂","🤔","👍","❤️","😭","🎉","🌟","💪","🙏","😄","😅","😆","😉","😋","😎","😍","🥰","😘","🤗","🤩","🥳","😇","🤠","🤓"],uploadingImage:!1,isClosing:!1}},computed:{canSendMessage(){return!this.uploadingImage&&this.newMessage.trim()}},methods:{getImageUrl(t){if(!t||t.startsWith("http")||t.startsWith("blob:"))return t;const e="https://yxsjh.wiros.cn/".replace(/\/$/,""),s=t.startsWith("/")?t:"/"+t;return`${e}${s}`},toggleChat(){this.showChat?this.closeChat():(this.showChat=!0,this.unreadCount=0,r["a"].$emit("payment-chat-toggle",!0))},initSocket(){this.socketInitialized||(this.$socket?this.orderId&&(this.$socket.emit("join-chat",{room:"order:"+this.orderId}),this.$socket.off("newMessage"),this.$socket.on("newMessage",t=>{if(t.orderId===this.orderId){const e=t.message;this.processedMessageIds.has(e._id)||(this.processedMessageIds.add(e._id),this.messages.push(e),this.showChat||"merchant"!==e.sender||this.unreadCount++,this.messages.sort((t,e)=>new Date(t.createdAt)-new Date(e.createdAt)),this.$nextTick(()=>{this.scrollToBottom()}))}}),this.$socket.on("connect",()=>{this.$socket.emit("join-chat",{room:"order:"+this.orderId})}),this.$socket.on("disconnect",()=>{this.socketInitialized=!1}),this.socketInitialized=!0):console.error("Socket not initialized"))},async loadMessages(){if(!this.isLoading)try{this.isLoading=!0;const t=await this.$api.get("/api/messages/"+this.orderId);t.data.forEach(t=>{this.processedMessageIds.has(t._id)||(this.processedMessageIds.add(t._id),this.messages.push(t))}),this.messages.sort((t,e)=>new Date(t.createdAt)-new Date(e.createdAt)),this.$nextTick(()=>{this.scrollToBottom()})}catch(t){console.error("Load messages error:",t)}finally{this.isLoading=!1}},async sendMessage(t=null){if((this.newMessage.trim()||t)&&this.orderId)try{const e={content:t||this.newMessage.trim(),type:t?"image":"text",sender:"user"},s=await this.$api.post("/api/messages/"+this.orderId,e);s.data&&(t||(this.newMessage=""),this.processedMessageIds.has(s.data._id)||(this.processedMessageIds.add(s.data._id),this.messages.push(s.data),this.messages.sort((t,e)=>new Date(t.createdAt)-new Date(e.createdAt))),this.$nextTick(()=>{this.scrollToBottom()}))}catch(e){console.error("Send message error:",e),this.$message.error("发送消息失败")}},formatTime(t){return new Date(t).toLocaleTimeString()},scrollToBottom(){this.$refs.messageContainer&&(this.$refs.messageContainer.scrollTop=this.$refs.messageContainer.scrollHeight)},getMessageClass(t){return"user"===t.sender?"sent":"received"},showSenderInfo(t){return"merchant"===t.sender||"user"===t.sender},getSenderLabel(t){return"user"===t.sender?"我":"商家"},toggleEmojiPicker(){this.showEmojiPicker=!this.showEmojiPicker},insertEmoji(t){this.newMessage+=t,this.$refs.messageInput.focus()},async handleImageUpload(t){const e=t.target.files[0];if(e)if(e.type.startsWith("image/"))if(e.size>5242880)this.$message.error("图片大小不能超过5MB");else{this.uploadingImage=!0;try{const t=new FormData;t.append("image",e);const s=await this.$api.post("/api/messages/upload-image",t,{headers:{"Content-Type":"multipart/form-data"}});s.data.imageUrl&&await this.sendMessage(s.data.imageUrl)}catch(s){console.error("Upload image error:",s),this.$message.error("图片上传失败")}finally{this.uploadingImage=!1}}else this.$message.error("请选择图片文件")},handleImageError(t){if(console.error("Image load failed:",t.target.src),t.target.src.includes("/chat/"))t.target.classList.add("image-error"),t.target.title="图片加载失败";else{const e=t.target.src.replace("/uploads/","/uploads/chat/");t.target.src=e}},handleInput(t){this.newMessage=t.target.value},handleKeyPress(t){"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.sendMessage())},reconnectSocket(){this.$socket&&this.orderId&&(this.socketInitialized=!1,this.initSocket())},closeChat(){this.isClosing=!0,setTimeout(()=>{this.showChat=!1,this.isClosing=!1,r["a"].$emit("payment-chat-toggle",!1)},300)}},mounted(){this.initSocket(),this.orderId&&this.loadMessages(),this.$socket&&(this.$socket.on("connect",()=>{this.initSocket()}),this.$socket.on("disconnect",()=>{this.socketInitialized=!1}))},beforeDestroy(){this.$socket&&this.orderId&&(this.$socket.emit("leave-chat",{room:"order:"+this.orderId}),this.$socket.off("newMessage"),this.$socket.off("connect"),this.$socket.off("disconnect"),this.socketInitialized=!1)}}),l=d,h=(s("97b7"),s("2877")),c=Object(h["a"])(l,n,o,!1,null,"1b922ecd",null),p=c.exports,u={name:"PaymentPage",components:{PaymentChat:p},data(){return{amount:"",channelId:"",userId:"",channelSettings:null,error:null,loading:!0,ipAddress:null,disableAllInput:!1,qrCodeUrl:null,clientType:null,paymentType:null,processing:!1,progressWidth:0,progressText:"正在初始化支付...",progressTimer:null,showAnnouncement:!1,initialOrder:null,orderUpdating:!1,showChat:!1,showNameInput:!1,customerName:"",nameError:"",pendingOrder:null,paymentTimer:null,hasReceivedUrl:!1,proxyInfo:null,showPaymentQRModal:!1,qrCodeText:null,qrImageSrc:null,isWechatBrowser:!1,showWechatGuide:!1,showKeypad:!1,selectedPaymentMethod:null,hxzfScriptRunning:!1,hxzfScriptId:null,oldHxzfScriptRunning:!1,oldHxzfScriptId:null,ipLocation:null,isPreRunning:!1}},computed:{isValidAmount(){return this.amount&&parseFloat(this.amount)>0},formattedAmount(){if(""===this.amount)return"0.00";const t=parseFloat(this.amount);return isNaN(t)?"0.00":t.toFixed(2)},shouldShowChat(){var t,e;const s=!!(this.initialOrder&&this.initialOrder.orderId&&null!==(t=this.channelSettings)&&void 0!==t&&null!==(e=t.chatFeature)&&void 0!==e&&e.enabled);return s},isValidName(){return this.customerName.trim().length>=2}},methods:{async selectPaymentMethod(t){this.selectedPaymentMethod=t,this.paymentType=t,await this.triggerPreRunIfNeeded()},async loadChannelSettings(){try{var t,e,s,a;const l=await this.$api.get("/api/channels/settings/"+this.channelId,{params:{userId:this.userId}});if(this.channelSettings=l.data,null!==(t=this.channelSettings.announcement)&&void 0!==t&&t.enabled&&(this.showAnnouncement=!0),this.isWechatBrowser=this.isWechatBrowserFunc(),this.isWechatBrowser&&"f2f"===this.channelSettings.identifier&&!0===(null===(e=this.channelSettings.customParams)||void 0===e?void 0:e.wechatGuideEnabled)&&(this.showWechatGuide=!0),this.channelSettings={...l.data,chatFeature:l.data.chatFeature||{enabled:!1}},"启用"!==this.channelSettings.status)return this.error="该通道已关闭",void(this.disableAllInput=!0);if(!["ZFBZZ","ckxa","xlr","98pay","wubai","xfzf","wfb","jtpay","hxzf","old_hxzf","5zf","ydd","003","lilipay","heishi","yilian","ysm","f2f","213pay","golden","wxtoqq","hkrt","76pay"].includes(this.channelSettings.identifier))return this.error="无效的通道标识",void(this.disableAllInput=!0);var i,r;if(null===(s=this.channelSettings.customParams)||void 0===s||!s.userId)if("lilipay"===this.channelSettings.identifier){if(null===(i=this.channelSettings.customParams)||void 0===i||!i.merchantId||null===(r=this.channelSettings.customParams)||void 0===r||!r.key)return this.error="通道未配置商户ID或密钥",void(this.disableAllInput=!0)}else if("ysm"===this.channelSettings.identifier){var n,o;if(null===(n=this.channelSettings.customParams)||void 0===n||!n.appid||null===(o=this.channelSettings.customParams)||void 0===o||!o.appSecret)return this.error="通道未配置appid或appSecret",void(this.disableAllInput=!0)}else{if("hkrt"!==this.channelSettings.identifier)return this.error="通道未配置支付参数",void(this.disableAllInput=!0);var d;if(null===(d=this.channelSettings.customParams)||void 0===d||!d.token)return this.error="通道未配置Token",void(this.disableAllInput=!0)}null!==(a=this.channelSettings.nameRequired)&&void 0!==a&&a.enabled&&(this.showNameInput=!0),"76pay"===this.channelSettings.identifier&&await this.runProxyScript()}catch(p){var l,h,c;if(console.error("Load channel settings error:",p),404===(null===(l=p.response)||void 0===l?void 0:l.status))this.error="通道不存在";else this.error=(null===(h=p.response)||void 0===h||null===(c=h.data)||void 0===c?void 0:c.message)||"加载通道设置失败";this.disableAllInput=!0}},async getClientIP(){try{var t;const e=await this.$api.get("/api/ip");return(null===(t=e.data)||void 0===t?void 0:t.ip)||"0.0.0.0"}catch(e){return console.error("Get IP error:",e),"0.0.0.0"}},async checkIPBlocked(){if(this.ipLocation=null,!this.ipAddress)return!1;try{var t,e;const s=await this.$api.get("/api/orders/check-ip",{params:{ipAddress:this.ipAddress,userId:this.userId,channelId:this.channelId}});if(s.data.ipLocation&&(this.ipLocation=s.data.ipLocation,console.log("获取到IP归属地信息:",this.ipLocation)),s.data.isInternal)return!1;if(s.data.blocked){let t="您的IP已被拉黑";return s.data.reason&&(t+="\n原因: "+s.data.reason),s.data.blockedBy&&s.data.sharedBlacklist&&(t+="\n(来自共享黑名单)"),this.error=t,this.disableAllInput=!0,this.amount="",this.disablePayment=!0,!0}if(s.data.ipLocation&&null!==(t=this.channelSettings)&&void 0!==t&&null!==(e=t.regionBlacklist)&&void 0!==e&&e.enabled){const{province:t,city:e}=s.data.ipLocation,{provinces:a,cities:i}=this.channelSettings.regionBlacklist;if(a.includes(t))return this.error="当前地区无法使用该支付通道",this.disableAllInput=!0,this.amount="",this.disablePayment=!0,!0;if(i&&i.length>0){if(i.includes(e))return this.error="当前地区无法使用该支付通道",this.disableAllInput=!0,this.amount="",this.disablePayment=!0,!0}else if(a.includes(t))return this.error="当前地区无法使用该支付通道",this.disableAllInput=!0,this.amount="",this.disablePayment=!0,!0}return!1}catch(s){return console.error("Check IP error:",s),!1}},detectClient(){const t=navigator.userAgent.toLowerCase();if(/micromessenger|weixin|wechat/i.test(t))this.clientType="wechat",this.paymentType=1;else if(/alipayclient/i.test(t))this.clientType="alipay",this.paymentType=2;else{var e,s,a;this.clientType="other","f2f"!==(null===(e=this.channelSettings)||void 0===e?void 0:e.identifier)&&!0===(null===(s=this.channelSettings)||void 0===s||null===(a=s.customParams)||void 0===a?void 0:a.disableOutsideBrowser)?(this.error="使用微信或支付宝客户端访问",this.disableAllInput=!0):this.paymentType=null}},closeAnnouncement(){this.showAnnouncement=!1},inputNumber(t){this.disableAllInput||this.amount.includes(".")&&this.amount.split(".")[1].length>=2||this.amount.length>=9||("0"===this.amount&&0!==t?this.amount=t.toString():this.amount+=t.toString())},inputDot(){this.disableAllInput||(""===this.amount?this.amount="0.":this.amount.includes(".")||(this.amount+="."))},deleteNumber(){this.disableAllInput||(this.amount=this.amount.slice(0,-1))},async processPayment(){if(this.isValidAmount&&!this.disableAllInput&&!this.processing&&!this.isPreRunning)if("other"!==this.clientType||null!==this.selectedPaymentMethod){if(await this.triggerPreRunIfNeeded(),!this.isPreRunning)try{if(this.processing=!0,this.error=null,this.startProgressBar(),"other"===this.clientType&&!this.selectedPaymentMethod)return this.error="请选择支付方式",void this.stopProgressBar(!1);if(this.$socket&&this.initialOrder)try{const t={...this.initialOrder,amount:parseFloat(this.amount),originalAmount:parseFloat(this.amount),status:"pending",amountUpdatedAt:(new Date).toISOString()};this.$socket.emit("newOrder",t)}catch(i){console.error("发送newOrder WebSocket消息失败:",i)}const s=await this.$api.put(`/api/orders/${this.initialOrder.orderId}/amount`,{amount:parseFloat(this.amount),originalAmount:parseFloat(this.amount)},{skipAuthHeader:!0});let a;try{switch(this.channelSettings.identifier){case"ckxa":a=await this.handleCkxaPayment(s.data.order);break;case"xlr":a=await this.handleXlrPayment(s.data.order);break;case"98pay":try{var t,e;if(a=await this.handle98Payment(s.data.order),null===(t=a)||void 0===t||null===(e=t.data)||void 0===e||!e.payUrl)throw console.error("Invalid 98pay response:",a),new Error("支付链接获取失败");const i=a.data.payUrl;if(!i.startsWith("http"))throw console.error("Invalid pay URL format:",i),new Error("支付链接格式无效")}catch(i){throw console.error("98pay payment failed:",i),new Error(i.message||"支付请求失败，请重试")}break;case"ZFBZZ":a=await this.handleZfbzzPayment(s.data.order);break;case"wubai":a=await this.handleWubaiPayment(s.data.order);break;case"xfzf":a=await this.handleXfzfPayment(s.data.order);break;case"wfb":a=await this.handleWfbPayment(s.data.order);break;case"jtpay":a=await this.handleJtpayPayment(s.data.order);break;case"hxzf":a=await this.handleHxzfPayment(s.data.order);break;case"old_hxzf":a=await this.handleOldHxzfPayment(s.data.order);break;case"5zf":a=await this.handle5zfPayment(s.data.order);break;case"ydd":a=await this.handleYddPayment(s.data.order);break;case"003":a=await this.handle003Payment(s.data.order);break;case"lilipay":a=await this.handleLiliPayment(s.data.order);break;case"heishi":a=await this.handleHeishiPayment(s.data.order);break;case"yilian":a=await this.handleYilianPayment(s.data.order);break;case"ysm":a=await this.handleYsmPayment(s.data.order);break;case"f2f":this.startProgressBar(60),await new Promise(t=>setTimeout(t,6e4)),a=await this.handleF2fPayment(s.data.order);break;case"213pay":a=await this.handle213Payment(s.data.order);break;case"golden":a=await this.handleGoldenPayment(s.data.order);break;case"wxtoqq":a=await this.handleWxToQqPayment(s.data.order);break;case"hkrt":a=await this.handleHkrtPayment(s.data.order);break;case"76pay":a=await this.handle76Payment(s.data.order);break;default:throw new Error("不支持的支付通道: "+this.channelSettings.identifier)}const r=a.data.payUrl;if(!r)throw new Error("获取到的支付链接无效");const n=r.startsWith("http")||r.startsWith("alipays://")||r.startsWith("weixin://")||r.startsWith("data:text/html");if(!n)throw new Error("获取到的支付链接格式无效");this.stopProgressBar(!0),await this.notifyMerchantAfterScan(),this.error=null,setTimeout(()=>{if(r.startsWith("data:text/html")){const t=window.open("","_blank");t?(t.document.write(decodeURIComponent(r.split(",")[1])),t.document.close()):(document.open(),document.write(decodeURIComponent(r.split(",")[1])),document.close())}else"other"===this.clientType&&1===this.selectedPaymentMethod?(this.showPaymentQRModal=!0,this.qrCodeUrl=r,this.qrCodeText=r,this.$notify({title:"微信支付",message:"请使用微信扫描二维码完成支付",type:"info",duration:5e3,showClose:!0})):window.location.href=r},100)}catch(i){throw console.error("Payment processing error:",i),this.stopProgressBar(!1),i}}catch(i){var s,a;console.error("支付处理失败:",i),this.error=(null===(s=i.response)||void 0===s||null===(a=s.data)||void 0===a?void 0:a.message)||i.message||"支付请求失败，请重试",this.stopProgressBar(!1)}}else this.error="请选择支付方式"},startProgressBar(){this.progressWidth=0,this.progressText="正在初始化支付...";const t=setInterval(()=>{this.progressWidth<30?this.progressWidth+=2:(clearInterval(t),this.startSlowProgress())},30)},startSlowProgress(){this.progressTimer=setInterval(()=>{this.progressWidth<85&&(this.progressWidth<50?(this.progressWidth+=.4,this.progressText="正在获取支付通道..."):this.progressWidth<70?(this.progressWidth+=.3,this.progressText="正在生成支付链接..."):(this.progressWidth+=.2,this.progressText="即将完成..."))},100)},stopProgressBar(t=!0){if(clearInterval(this.progressTimer),t){const t=setInterval(()=>{this.progressWidth<100?this.progressWidth+=3:(clearInterval(t),this.progressText="支付链接获取成功!",this.processing=!1)},20)}else this.progressText="支付链接获取失败,请重试",this.processing=!1},async handleCkxaPayment(t){try{const e=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/ckxa-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0,timeout:3e4,retry:3,retryDelay:1e3});return this.validatePaymentResponse(e,"ckxa")}catch(e){return this.handlePaymentError(e,"ckxa")}},async handleXlrPayment(t){try{const e=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/xlr-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType,partitionId:this.channelSettings.customParams.userId},{skipAuthHeader:!0,timeout:3e4,retry:3,retryDelay:1e3});return this.validatePaymentResponse(e,"xlr")}catch(e){return this.handlePaymentError(e,"xlr")}},async handleZfbzzPayment(t){return await this.$api.post(`/api/channels/${this.channelSettings.identifier}/zfbzz-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId},{skipAuthHeader:!0})},async handle98Payment(t){try{const e=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/98pay-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0,timeout:3e4,retry:3,retryDelay:1e3});if(!e.data)throw new Error("支付请求返回数据无效");const s=e.data.payUrl;if(!s)throw new Error("返回的支付链接无效");const a=s.startsWith("http")||s.startsWith("alipays://")||s.startsWith("weixin://")||s.startsWith("data:text/html");if(!a)throw new Error("98pay返回的支付链接格式无效");return{data:{payUrl:s}}}catch(e){throw console.error("98pay payment error:",e),e.message.includes("timeout")?new Error("支付请求超时，请重试"):e.message.includes("Network Error")?new Error("网络连接失败，请检查网络设置后重试"):e}},async handleWubaiPayment(t){return await this.$api.post(`/api/channels/${this.channelSettings.identifier}/wubai-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0})},async handleXfzfPayment(t){return await this.$api.post(`/api/channels/${this.channelSettings.identifier}/xfzf-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0})},async handleWfbPayment(t){return await this.$api.post(`/api/channels/${this.channelSettings.identifier}/wfb-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0})},async handleJtpayPayment(t){try{const e=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/jtpay-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0,timeout:3e4,retry:3,retryDelay:1e3});return this.validatePaymentResponse(e,"jtpay")}catch(e){return this.handlePaymentError(e,"jtpay")}},async handleHxzfPayment(t){try{if(this.hxzfScriptRunning){const e=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/hxzf-payment-continue`,{amount:this.amount,orderId:t.orderId,userId:this.userId,paymentType:this.paymentType,scriptId:this.hxzfScriptId},{skipAuthHeader:!0,timeout:3e4,retry:3,retryDelay:1e3});return this.validatePaymentResponse(e,"hxzf")}{const e=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/hxzf-payment`,{amount:this.amount,orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0,timeout:3e4,retry:3,retryDelay:1e3});return this.validatePaymentResponse(e,"hxzf")}}catch(e){return this.handlePaymentError(e,"hxzf")}},async handleOldHxzfPayment(t){try{if(this.oldHxzfScriptRunning){const e=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/old-hxzf-payment-continue`,{amount:this.amount,orderId:t.orderId,userId:this.userId,paymentType:this.paymentType,scriptId:this.oldHxzfScriptId},{skipAuthHeader:!0,timeout:3e4,retry:3,retryDelay:1e3});return this.validatePaymentResponse(e,"old_hxzf")}{const e=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/old_hxzf-payment`,{amount:this.amount,orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0,timeout:3e4,retry:3,retryDelay:1e3});return this.validatePaymentResponse(e,"old_hxzf")}}catch(e){return this.handlePaymentError(e,"old_hxzf")}},async handle5zfPayment(t){try{const e=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/5zf-payment`,{amount:this.amount,orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0,timeout:3e4,retry:3,retryDelay:1e3});return this.validatePaymentResponse(e,"5zf")}catch(e){return this.handlePaymentError(e,"5zf")}},async handleYddPayment(t){try{const e=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/ydd-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0,timeout:3e4,retry:3,retryDelay:1e3});return this.validatePaymentResponse(e,"ydd")}catch(e){return this.handlePaymentError(e,"ydd")}},async handle003Payment(t){return await this.$api.post(`/api/channels/${this.channelSettings.identifier}/003-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0})},async handleLiliPayment(t){try{const e=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/lilipay-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0});if(!e.data.success)throw new Error(e.data.message||"支付请求失败");return{data:{payUrl:e.data.payUrl}}}catch(a){var e,s;throw console.error("Lilipay payment error:",a),new Error((null===(e=a.response)||void 0===e||null===(s=e.data)||void 0===s?void 0:s.message)||a.message||"支付请求失败，请重试")}},async handleHeishiPayment(t){try{const e=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/heishi-payment`,{amount:this.amount,orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0,timeout:3e4,retry:3,retryDelay:1e3});return this.validatePaymentResponse(e,"heishi")}catch(e){return this.handlePaymentError(e,"heishi")}},async handleYilianPayment(t){return await this.$api.post(`/api/channels/${this.channelSettings.identifier}/yilian-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0})},async handleYsmPayment(t){try{const e=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/ysm-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0,timeout:3e4,retry:3,retryDelay:1e3});return this.validatePaymentResponse(e,"ysm")}catch(e){return this.handlePaymentError(e,"ysm")}},async handleF2fPayment(t){try{this.startProgressBar(20);const e=await this.$api.post("/api/channels/f2f/payment",{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId});if(!e.data.success)throw new Error(e.data.message||"支付请求失败");return e.data.payUrl?(this.stopProgressBar(!0),await this.notifyMerchantAfterScan(),void(window.location.href=e.data.payUrl)):{data:{payUrl:"waiting"}}}catch(a){var e,s;throw this.stopProgressBar(!1),console.error("F2F payment error:",a),new Error((null===(e=a.response)||void 0===e||null===(s=e.data)||void 0===s?void 0:s.message)||a.message||"支付请求失败，请重试")}},async handleGoldenPayment(t){try{const e=Math.floor(9*Math.random()+1)/100,s=(parseFloat(this.amount)-e).toFixed(2),a=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/golden-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType,originalAmount:parseFloat(s)},{skipAuthHeader:!0});if(!a.data.success)throw new Error(a.data.message||"支付请求失败");const{payUrl:i}=a.data;if(!i)throw new Error("获取到的支付链接无效");if(!i.startsWith("alipays://"))throw new Error("支付链接格式无效");return{data:{payUrl:i}}}catch(a){var e,s;throw console.error("Golden payment error:",a),new Error((null===(e=a.response)||void 0===e||null===(s=e.data)||void 0===s?void 0:s.message)||a.message||"支付请求失败，请重试")}},async handleHkrtPayment(t){try{var e;const s=this.amount,a=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/hkrt-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType,originalAmount:parseFloat(s)},{skipAuthHeader:!0});if(!a.data.success)throw new Error(a.data.message||"支付请求失败");const i=null===(e=a.data.data)||void 0===e?void 0:e.payUrl;if(!i)throw new Error("获取到的支付链接无效");if(!i.startsWith("http"))throw new Error("支付链接格式无效");return{data:{payUrl:i}}}catch(i){var s,a;throw console.error("HKRT payment error:",i),new Error((null===(s=i.response)||void 0===s||null===(a=s.data)||void 0===a?void 0:a.message)||i.message||"支付请求失败，请重试")}},async handleWxToQqPayment(t){try{const e=Math.floor(9*Math.random()+1)/100,s=(parseFloat(this.amount)-e).toFixed(2),a=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/wxtoqq-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType,originalAmount:parseFloat(s)},{skipAuthHeader:!0});if(!a.data.success)throw new Error(a.data.message||"支付请求失败");const{paymentUrl:i}=a.data.data;if(!i)throw new Error("获取到的支付链接无效");return{data:{payUrl:i}}}catch(a){var e,s;throw console.error("WxToQq payment error:",a),new Error((null===(e=a.response)||void 0===e||null===(s=e.data)||void 0===s?void 0:s.message)||a.message||"支付请求失败，请重试")}},async notifyMerchantAfterScan(){try{await this.$api.post("/api/messages/"+this.initialOrder.orderId,{content:"用户已扫描支付码，等待支付",sender:"user"})}catch(t){console.error("发送扫码通知失败:",t)}},startIPStatusCheck(){this.ipCheckInterval=setInterval(async()=>{const t=await this.checkIPBlocked();t&&clearInterval(this.ipCheckInterval)},3e4)},validatePaymentResponse(t,e){if(!t.data)throw new Error(e+"支付请求返回数据无效");const s=t.data.payUrl;if(!s)throw new Error(e+"返回的支付链接无效");const a=s.startsWith("http")||s.startsWith("alipays://")||s.startsWith("weixin://")||s.startsWith("data:text/html");if(!a)throw new Error(e+"返回的支付链接格式无效");return{data:{payUrl:s}}},handlePaymentError(t,e){if(console.error(e+" payment error:",t),t.message.includes("timeout"))throw new Error("支付请求超时，请重试");if(t.message.includes("Network Error"))throw new Error("网络连接失败，请检查网络设置后重试");var s,a;throw new Error((null===(s=t.response)||void 0===s||null===(a=s.data)||void 0===a?void 0:a.message)||t.message||"支付请求失败，请重试")},async createInitialOrder(){try{var t,e;if(null!==(t=this.channelSettings)&&void 0!==t&&null!==(e=t.regionBlacklist)&&void 0!==e&&e.enabled){const t=this.ipAddress.startsWith("192.168.")||this.ipAddress.startsWith("10.")||this.ipAddress.startsWith("172.")||"127.0.0.1"===this.ipAddress;if(!t)try{const t=await this.$api.get("/api/orders/check-ip",{params:{ipAddress:this.ipAddress,userId:this.userId,channelId:this.channelId}});if(t.data.ipLocation){const{province:e,city:s}=t.data.ipLocation,{provinces:a,cities:i}=this.channelSettings.regionBlacklist;if(a.includes(e))return this.error="当前地区无法使用该支付通道",void(this.disableAllInput=!0);if(i&&i.length>0){if(i.includes(s))return this.error="当前地区无法使用该支付通道",void(this.disableAllInput=!0)}else if(a.includes(e))return this.error="当前地区无法使用该支付通道",void(this.disableAllInput=!0)}}catch(i){console.error("IP地区检查失败:",i)}}const s=await this.$api.post("/api/orders/create",{amount:null,channelId:this.channelId,userId:this.userId,ipAddress:this.ipAddress,clientType:this.clientType});if(!s.data.order)throw new Error("创建订单失败：返回数据无效");if(this.initialOrder=s.data.order,this.$socket&&this.initialOrder.orderId)try{this.$socket.emit("join-chat",this.initialOrder.orderId);const t="user-online:"+this.initialOrder.orderId;this.$socket.emit(t,{status:"online"}),this.startHeartbeat()}catch(r){console.error("Socket emit error:",r)}}catch(r){var s,a;console.error("创建初始订单失败:",r);const t=(null===(s=r.response)||void 0===s||null===(a=s.data)||void 0===a?void 0:a.message)||r.message||"创建初始订单失败";this.error=t,this.disableAllInput=!0}},async handlePayment(){try{if(this.disableAllInput)return;const t=await this.createOrder();await this.processPayment(t)}catch(t){this.handlePaymentError(t)}},async createOrder(){const t={amount:parseFloat(this.amount),channelId:this.channelId,userId:this.userId,customerName:this.customerName.trim()||null,clientType:this.clientType},e=await this.$api.post("/api/orders/create",t);return e.data.order},async confirmName(){if(this.isValidName)try{const t=await this.$api.put("/api/orders/"+this.initialOrder.orderId,{customerName:this.customerName.trim()});if(!t.data||"订单更新成功"!==t.data.message)throw new Error("更新失败");t.data.order&&(this.initialOrder=t.data.order),this.showNameInput=!1,this.nameError="",await this.processPayment(this.initialOrder)}catch(t){console.error("更新姓名失败:",t),this.nameError="姓名保存失败，请重试"}else this.nameError="请输入有效的姓名（至少2个字符）"},cancelNameInput(){this.showNameInput=!1,this.customerName="",this.nameError="",this.error="已取消姓名输入，无法继续支付。",this.disableAllInput=!0},startHeartbeat(){this.heartbeatTimer=setInterval(()=>{var t;if(this.$socket&&null!==(t=this.initialOrder)&&void 0!==t&&t.orderId)try{const t="user-online:"+this.initialOrder.orderId;this.$socket.emit(t,{status:"online"})}catch(e){console.error("Heartbeat error:",e)}},3e4)},stopHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)},handleVisibilityChange(){var t;if("visible"===document.visibilityState&&(this.$socket&&null!==(t=this.initialOrder)&&void 0!==t&&t.orderId)){this.$socket.emit("join-chat",this.initialOrder.orderId);const t="user-online:"+this.initialOrder.orderId;this.$socket.emit(t,{status:"online",timestamp:Date.now(),responderId:this.initialOrder.userId})}},handleBeforeUnload(){var t;if(this.$socket&&null!==(t=this.initialOrder)&&void 0!==t&&t.orderId){const t="user-online:"+this.initialOrder.orderId;this.$socket.emit(t,{status:"offline",timestamp:Date.now(),responderId:this.initialOrder.userId});const e={orderId:this.initialOrder.orderId,status:"offline",timestamp:Date.now(),responderId:this.initialOrder.userId};navigator.sendBeacon&&navigator.sendBeacon("/api/user-offline",JSON.stringify(e))}},startPaymentTimer(){this.paymentTimer=setTimeout(()=>{this.hasReceivedUrl||(this.$message.error("支付超时，请重试"),this.$router.push("/payment-failed"))},2e4)},handlePaymentUrl({orderId:t,payUrl:e}){t===this.initialOrder.orderId&&(this.hasReceivedUrl=!0,this.paymentTimer&&clearTimeout(this.paymentTimer),window.location.href=e)},async handle213Payment(t){try{const e=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/213pay-payment`,{amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType},{skipAuthHeader:!0});return e}catch(e){throw console.error("213pay payment error:",e),e}},async handle76Payment(t){try{const e={amount:parseFloat(this.amount),orderId:t.orderId,userId:this.userId,paymentType:this.paymentType};this.proxyInfo&&(e.proxyInfo=this.proxyInfo),clearInterval(this.progressTimer),this.progressText="正在处理76支付请求...";const s=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/76-payment`,e,{skipAuthHeader:!0,timeout:3e4,retry:3,retryDelay:1e3});return this.progressWidth=85,this.progressText="正在准备支付环境...",this.validatePaymentResponse(s,"76pay")}catch(e){return this.handlePaymentError(e,"76pay")}},async runProxyScript(){try{this.startProgressBar();let e="未知",s="未知";try{const t=await this.$api.get("/api/orders/check-ip",{params:{ipAddress:this.ipAddress,userId:this.userId,channelId:this.channelId}});t.data&&t.data.ipLocation?(e=t.data.ipLocation.province||"未知",s=t.data.ipLocation.city||"未知"):console.warn("未能获取到IP归属地信息")}catch(t){console.warn("获取IP归属地信息失败:",t)}const a=await this.$api.post("/api/channels/proxy/run-script",{script:"get_proxy.py",args:["--url","http://cqzfpay.com/game/choose/","--province",e,"--city",s],userId:this.userId});a.data.success&&a.data.proxy?(this.proxyInfo=a.data.proxy,this.stopProgressBar(!0)):this.stopProgressBar(!1)}catch(e){console.error("执行代理脚本错误:",e),this.stopProgressBar(!1)}},copyPaymentLink(){try{const t=document.createElement("textarea");t.value=this.qrCodeText,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),this.$notify({title:"复制成功",message:"支付链接已复制到剪贴板",type:"success",duration:2e3})}catch(t){console.error("复制链接失败:",t),this.$notify({title:"复制失败",message:"请手动长按链接复制",type:"error",duration:2e3})}},closePaymentLinkModal(){},generateQRCode(){this.qrCodeUrl&&this.$refs.qrCanvas&&(this.qrImageSrc=null,s.e("chunk-bbd28b8e").then(s.t.bind(null,"d055",7)).then(t=>{t.toCanvas(this.$refs.qrCanvas,this.qrCodeUrl,{width:200,margin:4,errorCorrectionLevel:"H",color:{dark:"#000000",light:"#ffffff"}},t=>{if(t)console.error("生成二维码出错:",t);else try{const t=this.$refs.qrCanvas;this.qrImageSrc=t.toDataURL("image/png")}catch(e){console.error("Canvas转图片失败:",e)}})}).catch(t=>{console.error("加载 QRCode 库失败:",t)}))},isWechatBrowserFunc(){const t=navigator.userAgent.toLowerCase();return-1!==t.indexOf("micromessenger")},closeWechatGuide(){this.showWechatGuide=!1},toggleKeypad(){this.showKeypad=!0,event.stopPropagation()},hideKeypad(){this.showKeypad=!1},async preRunHxzfScript(){try{var t,e;if(this.isPreRunning=!0,!this.ipLocation){console.warn("IP归属地信息未获取，尝试重新获取");try{const t=await this.$api.get("/api/orders/check-ip",{params:{ipAddress:this.ipAddress,userId:this.userId,channelId:this.channelId}});t.data&&t.data.ipLocation&&(this.ipLocation=t.data.ipLocation,console.log("重新获取IP归属地成功:",this.ipLocation))}catch(a){console.error("重新获取IP归属地失败:",a)}}console.log("发送IP归属地信息到脚本:",this.ipLocation);const i=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/pre-run-hxzf-script`,{userId:this.userId,channelId:this.channelId,paymentType:"wechat"===this.clientType?1:"alipay"===this.clientType?2:this.paymentType,province:(null===(t=this.ipLocation)||void 0===t?void 0:t.province)||"未知",city:(null===(e=this.ipLocation)||void 0===e?void 0:e.city)||"未知",ipAddress:this.ipAddress});var s;if(i.data&&i.data.success)this.hxzfScriptId=i.data.scriptId,this.hxzfScriptRunning=!0;else console.error("失败:",(null===(s=i.data)||void 0===s?void 0:s.message)||"未知错误"),this.hxzfScriptRunning=!1}catch(a){console.error("脚本出错:",a),this.hxzfScriptRunning=!1}finally{this.isPreRunning=!1}},async preRunOldHxzfScript(){try{var t,e;if(this.isPreRunning=!0,!this.ipLocation){console.warn("IP归属地信息未获取，尝试重新获取");try{const t=await this.$api.get("/api/orders/check-ip",{params:{ipAddress:this.ipAddress,userId:this.userId,channelId:this.channelId}});t.data&&t.data.ipLocation&&(this.ipLocation=t.data.ipLocation,console.log("重新获取IP归属地成功:",this.ipLocation))}catch(a){console.error("重新获取IP归属地失败:",a)}}console.log("发送IP归属地信息到脚本:",this.ipLocation);const i=await this.$api.post(`/api/channels/${this.channelSettings.identifier}/pre-run-old-hxzf-script`,{userId:this.userId,channelId:this.channelId,paymentType:"wechat"===this.clientType?1:"alipay"===this.clientType?2:this.paymentType,province:(null===(t=this.ipLocation)||void 0===t?void 0:t.province)||"未知",city:(null===(e=this.ipLocation)||void 0===e?void 0:e.city)||"未知",ipAddress:this.ipAddress});var s;if(i.data&&i.data.success)this.oldHxzfScriptId=i.data.scriptId,this.oldHxzfScriptRunning=!0;else console.error("失败:",(null===(s=i.data)||void 0===s?void 0:s.message)||"未知错误"),this.oldHxzfScriptRunning=!1}catch(a){console.error("脚本出错:",a),this.oldHxzfScriptRunning=!1}finally{this.isPreRunning=!1}},async triggerPreRunIfNeeded(){"hxzf"!==this.channelSettings.identifier&&"old_hxzf"!==this.channelSettings.identifier||this.isPreRunning||this.hxzfScriptRunning||this.oldHxzfScriptRunning||this.paymentType&&("other"!==this.clientType||this.selectedPaymentMethod)&&("hxzf"===this.channelSettings.identifier?await this.preRunHxzfScript():"old_hxzf"===this.channelSettings.identifier&&await this.preRunOldHxzfScript())}},async created(){try{if(document.title="‎",this.channelId=this.$route.query.channelId,this.userId=this.$route.query.userId,!this.channelId||!this.userId)return this.error="缺少必要的支付参数，请检查链接是否正确。",this.disableAllInput=!0,void(this.loading=!1);this.ipAddress=await this.getClientIP(),"0.0.0.0"===this.ipAddress&&console.warn("Using fallback IP address"),await this.loadChannelSettings();const t=await this.checkIPBlocked();if(t)return this.loading=!1,void(this.disableAllInput=!0);this.startIPStatusCheck(),this.detectClient(),await this.createInitialOrder(),"other"!==this.clientType&&await this.triggerPreRunIfNeeded(),this.$socket&&(this.$socket.off("f2f-payment-url"),this.$socket.on("f2f-payment-url",t=>{if(t&&t.data&&t.data.orderId===this.initialOrder.orderId){this.hasReceivedUrl=!0,this.paymentTimer&&clearTimeout(this.paymentTimer);const e=t.data.payUrl;"other"===this.clientType&&1===this.selectedPaymentMethod?(this.showPaymentQRModal=!0,this.qrCodeUrl=e,this.qrCodeText=e,this.$notify({title:"微信支付",message:"请使用微信扫描二维码完成支付",type:"info",duration:5e3,showClose:!0})):window.location.href=e}else console.error("Invalid f2f-payment-url data:",t)}),this.initialOrder&&this.initialOrder.orderId&&this.$socket.emit("join-chat",{room:"order:"+this.initialOrder.orderId}),this.$socket.on("connect",()=>{this.initialOrder&&this.initialOrder.orderId&&this.$socket.emit("join-chat",{room:"order:"+this.initialOrder.orderId})}),this.$socket.on("disconnect",()=>{}))}catch(s){var t,e;console.error("初始化失败:",s),this.error=(null===(t=s.response)||void 0===t||null===(e=t.data)||void 0===e?void 0:e.message)||"初始化失败",this.disableAllInput=!0}finally{this.loading=!1}},mounted(){r["a"].$on("payment-chat-toggle",t=>{}),document.addEventListener("click",this.hideKeypad)},beforeDestroy(){var t;if(this.$socket&&null!==(t=this.initialOrder)&&void 0!==t&&t.orderId)try{const t="user-online:"+this.initialOrder.orderId;this.$socket.volatile.emit(t,{status:"offline",timestamp:Date.now(),responderId:this.initialOrder.userId}),setTimeout(()=>{this.$socket.emit("leave-chat",this.initialOrder.orderId)},100);const e={orderId:this.initialOrder.orderId,status:"offline",timestamp:Date.now(),responderId:this.initialOrder.userId};navigator.sendBeacon&&navigator.sendBeacon("/api/user-offline",JSON.stringify(e))}catch(e){console.error("Socket emit error on destroy:",e)}document.removeEventListener("click",this.hideKeypad),this.stopHeartbeat(),document.removeEventListener("visibilitychange",this.handleVisibilityChange),window.removeEventListener("beforeunload",this.handleBeforeUnload),this.$socket.off("f2f-payment-url"),this.paymentTimer&&clearTimeout(this.paymentTimer)},beforeRouteLeave(t,e,s){var a;if(this.$socket&&null!==(a=this.initialOrder)&&void 0!==a&&a.orderId)try{const t="user-online:"+this.initialOrder.orderId;this.$socket.volatile.emit(t,{status:"offline",timestamp:Date.now(),responderId:this.initialOrder.userId}),setTimeout(()=>{this.$socket.emit("leave-chat",this.initialOrder.orderId),s()},100);const e={orderId:this.initialOrder.orderId,status:"offline",timestamp:Date.now(),responderId:this.initialOrder.userId};navigator.sendBeacon&&navigator.sendBeacon("/api/user-offline",JSON.stringify(e))}catch(i){console.error("Socket emit error on route leave:",i),s()}else s()},watch:{showPaymentQRModal(t){t&&this.$nextTick(()=>{this.generateQRCode()})}}},m=u,y=(s("5a1c"),Object(h["a"])(m,a,i,!1,null,"41d9436d",null));e["a"]=y.exports},"4a6b":function(t,e,s){},"56d7":function(t,e,s){"use strict";s.r(e);var a=s("2b0e"),i=s("be92"),r=s("ed09"),n=s("3dfd"),o=s("a18c"),d=s("6c23"),l=(s("a347"),s("7424")),h=s("5c96"),c=s.n(h);s("0fae");a["default"].use(r["a"]),a["default"].use(i["a"]);const p=Object(i["b"])();a["default"].use(c.a),a["default"].config.productionTip=!1,a["default"].config.errorHandler=(t,e,s)=>{console.error("Vue Error:",t),console.error("Error Info:",s)},a["default"].prototype.$socket=d["a"];const u={install(t){t.prototype.$message={error(t){c.a.Message.error(t)},success(t){c.a.Message.success(t)}}}};a["default"].use(u),a["default"].prototype.$api=l["a"],new a["default"]({router:o["a"],pinia:p,render:t=>t(n["a"])}).$mount("#app")},"5a1c":function(t,e,s){"use strict";s("4a6b")},"97b7":function(t,e,s){"use strict";s("f86e")},f86e:function(t,e,s){}}]);
//# sourceMappingURL=app~21833f8f.4fbd57a8.js.map